apiVersion: batch/v1
kind: Job
metadata:
  name: comesa-tests-job
  namespace: ${app.namespace}
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app.kubernetes.io/name: comesa-tests-job
        job-name: comesa-tests-job
        sidecar.istio.io/inject: 'false'
    spec:
      volumes:
        - name: comesa-tests-config-vol
          configMap:
            name: comesa-tests-config
        - name: comesa-tests-ttk-environments-vol
          configMap:
            name: ttk-backend-config-extra-environments
      containers:
        - name: comesa-gp
          image: ghcr.io/infitx-org/comesa-tests:latest
          command:
            - /bin/sh
            - '-c'
          args:
            - |
              until nslookup ttk-backend.${app.namespace}.svc.cluster.local; do sleep 5;done;

# %{ for scheme_name, scheme in app.testConfig.multiSchemeConfig }
# %{ if app.testConfig.dfspConfig[scheme.dfsp].enabled }
# %{ for target in scheme.targets }
# %{ if app.testConfig.dfspConfig[target.dfsp].enabled }
              npx ml-ttk-cli -- \
                -e ttk-environments/multi_scheme_${scheme.dfsp}_to_${target.dfsp}.json \
                -i ttk-test-collection \
                -u http://ttk-backend:5050 \
                --report-format json \
                --save-report true \
                --report-name comesa_gp_collection \
                --save-report-base-url https://ttkfront-${app.namespace}.${cluster.env}.${cluster.domain};
              export EXIT_CODE_${scheme.dfsp}_to_${target.dfsp}="$?";
              echo "Test ${scheme.dfsp} to ${target.dfsp} finished with exit code: $EXIT_CODE_${scheme.dfsp}_to_${target.dfsp}";
              export TOTAL_EXIT_CODE="$EXIT_CODE || $EXIT_CODE_${scheme.dfsp}_to_${target.dfsp}";
# %{ endif }
# %{ endfor }
# %{ endif }
# %{ endfor }
             exit $TOTAL_EXIT_CODE;
          volumeMounts:
            - name: comesa-tests-config-vol
              mountPath: /opt/app/config
            - name: comesa-tests-ttk-environments-vol
              mountPath: /opt/app/ttk-environments
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          imagePullPolicy: IfNotPresent
      restartPolicy: Never
      terminationGracePeriodSeconds: 30
